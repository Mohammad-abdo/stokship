// ============================================
// MEDIATION PLATFORM SCHEMA
// ============================================
// This schema represents the mediation/brokerage platform
// where the platform acts as a financial intermediary

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  ADMIN
  MODERATOR
  EMPLOYEE
  TRADER
  CLIENT
}

enum UserType {
  ADMIN
  MODERATOR
  EMPLOYEE
  TRADER
  CLIENT
  SYSTEM
}

enum OfferStatus {
  DRAFT
  PENDING_VALIDATION
  ACTIVE
  CLOSED
  REJECTED
}

enum DealStatus {
  NEGOTIATION
  APPROVED
  PAID
  SETTLED
  CANCELLED
  DISPUTED
}

enum NegotiationMessageType {
  TEXT
  PRICE_PROPOSAL
  QUANTITY_PROPOSAL
  TERMS_PROPOSAL
  SYSTEM_NOTIFICATION
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  HELD
}

enum PaymentMethod {
  BANK_TRANSFER
  BANK_CARD
  WALLET
}

enum TransactionType {
  DEPOSIT // Client pays platform
  COMMISSION // Platform commission
  EMPLOYEE_COMMISSION // Employee commission
  TRADER_PAYOUT // Trader receives payment
  REFUND // Refund to client
  ADJUSTMENT // Manual adjustment
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  PENDING
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum TraderUpdateRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum OfferUpdateRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum OfferSupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum OfferSupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AuditAction {
  DEAL_CREATED
  DEAL_UPDATED
  DEAL_APPROVED
  DEAL_PAID
  DEAL_SETTLED
  NEGOTIATION_MESSAGE
  PAYMENT_RECEIVED
  COMMISSION_CALCULATED
  EMPLOYEE_INTERVENTION
  DISPUTE_RAISED
}

// ============================================
// CORE USER ENTITIES
// ============================================

model Admin {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          String    @default("admin")
  isActive      Boolean   @default(true)
  isSuperAdmin  Boolean   @default(false)
  lastLoginAt   DateTime?
  rememberToken String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  createdEmployees      Employee[]
  activityLogs          ActivityLog[]          @relation("ActivityLogAdmin")
  auditTrails           AuditTrail[]           @relation("AuditTrailAdmin")
  financialTransactions FinancialTransaction[] @relation("FinancialTransactionAdmin")

  // Content & Settings
  contentPagesCreated     ContentPage[]      @relation("ContentPageCreator")
  contentPagesUpdated     ContentPage[]      @relation("ContentPageUpdater")
  platformSettingsUpdated PlatformSettings[] @relation("PlatformSettingsUpdater")
}

model Moderator {
  id          String    @id @default(uuid())
  email       String    @unique
  password    String
  name        String
  role        String    @default("moderator")
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  activityLogs ActivityLog[] @relation("ActivityLogModerator")
  auditTrails  AuditTrail[]  @relation("AuditTrailModerator")
}

model Employee {
  id             String    @id @default(uuid())
  email          String    @unique
  password       String
  name           String
  phone          String?
  employeeCode   String    @unique // Auto-generated
  isActive       Boolean   @default(true)
  commissionRate Decimal   @default(1.0) @db.Decimal(5, 2) // Percentage
  createdBy      String // Admin ID
  lastLoginAt    DateTime?
  rememberToken  String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  createdByAdmin        Admin                  @relation(fields: [createdBy], references: [id])
  traders               Trader[] // Traders linked to this employee
  deals                 Deal[] // Deals this employee guarantees
  activityLogs          ActivityLog[]          @relation("ActivityLogEmployee")
  auditTrails           AuditTrail[]           @relation("AuditTrailEmployee")
  traderUpdateRequests  TraderUpdateRequest[]  @relation("TraderUpdateRequestReviewer")
  offerUpdateRequests   OfferUpdateRequest[]   @relation("OfferUpdateRequestReviewer")
  financialTransactions FinancialTransaction[] @relation("FinancialTransactionEmployee")
  offerSupportTickets   OfferSupportTicket[]   @relation("OfferSupportTicketEmployee")

  @@index([createdBy])
  @@index([employeeCode])
}

model Trader {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  name              String
  companyName       String
  phone             String?
  countryCode       String?
  country           String?
  city              String?
  companyAddress    String?   @db.Text
  bankAccountName   String?
  bankAccountNumber String?
  bankName          String?
  bankAddress       String?   @db.Text
  bankCode          String?
  swiftCode         String?
  traderCode        String    @unique // Auto-generated (e.g., TRD-001)
  barcode           String    @unique // Barcode/QR code
  qrCodeUrl         String? // QR code image URL
  employeeId        String? // Permanently linked to this employee
  isActive          Boolean   @default(true)
  isVerified        Boolean   @default(false)
  verifiedAt        DateTime?
  lastLoginAt       DateTime?
  rememberToken     String?
  clientId          String?   @unique // Link to client profile
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  employee         Employee?             @relation(fields: [employeeId], references: [id])
  client           Client?               @relation(fields: [clientId], references: [id])
  offers           Offer[]
  deals            Deal[]
  dealNegotiations DealNegotiation[]     @relation("DealNegotiationTrader")
  activityLogs     ActivityLog[]         @relation("ActivityLogTrader")
  auditTrails      AuditTrail[]          @relation("AuditTrailTrader")
  updateRequests   TraderUpdateRequest[]
  offerSupportTickets OfferSupportTicket[] @relation("OfferSupportTicketTrader")

  @@index([employeeId])
  @@index([clientId])
  @@index([traderCode])
  @@index([barcode])
}

model Client {
  id                  String    @id @default(uuid())
  email               String    @unique
  password            String
  name                String
  phone               String?
  countryCode         String?
  country             String?
  city                String?
  isActive            Boolean   @default(true)
  isEmailVerified     Boolean   @default(false)
  termsAccepted       Boolean   @default(false)
  termsAcceptedAt     DateTime?
  language            String    @default("ar")
  preferredCategories String?   @db.Text // JSON array of category IDs
  lastLoginAt         DateTime?
  rememberToken       String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  deals            Deal[]
  dealNegotiations DealNegotiation[] @relation("DealNegotiationClient")
  payments         Payment[]
  activityLogs     ActivityLog[]     @relation("ActivityLogClient")
  auditTrails      AuditTrail[]      @relation("AuditTrailClient")
  trader           Trader?
}

// ============================================
// OFFER MANAGEMENT
// ============================================

model Offer {
  id                 String      @id @default(uuid())
  traderId           String
  title              String
  description        String?     @db.Text
  status             OfferStatus @default(DRAFT)
  totalCartons       Int         @default(0)
  totalCBM           Decimal     @default(0) @db.Decimal(10, 3)
  // Ad/Offer metadata from create page
  category           String? // Category from create page (electronics, clothing, etc.) - Legacy field for backward compatibility
  categoryId         String? // Category ID - New field for relation
  acceptsNegotiation Boolean     @default(false) // Whether trader accepts negotiation
  country            String? // Country from create page (Stockship Fees section)
  city               String? // City from create page (Stockship Fees section)
  images             String?     @db.Text // JSON array of main ad images (Upload Images section)
  // Excel file storage
  excelFileUrl       String? // Original Excel file URL/path
  excelFileName      String? // Original Excel file name
  excelFileSize      Int? // File size in bytes
  // Excel metadata
  companyName        String? // Company name from Excel header
  proformaInvoiceNo  String? // Proforma Invoice No from Excel header
  excelDate          DateTime? // DATE from Excel header
  validatedBy        String? // Employee ID who validated
  validatedAt        DateTime?
  validationNotes    String?     @db.Text
  closedAt           DateTime?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  // Relations
  trader           Trader        @relation(fields: [traderId], references: [id])
  categoryRelation Category?     @relation("OfferCategory", fields: [categoryId], references: [id])
  items            OfferItem[]
  deals            Deal[]
  activityLogs     ActivityLog[] @relation("ActivityLogOffer")
  updateRequests   OfferUpdateRequest[]
  supportTickets   OfferSupportTicket[]

  @@index([traderId])
  @@index([status])
  @@index([categoryId])
}

model OfferItem {
  id              String   @id @default(uuid())
  offerId         String
  // Excel-based fields
  itemNo          String? // Item number from Excel (ITEM NO.)
  productName     String // Descriptive name only (DESCRIPTION)
  description     String?  @db.Text
  colour          String? // Colour from Excel
  spec            String? // SPEC. from Excel
  quantity        Int // QUANTITY from Excel
  unit            String? // Unit from Excel (SET, PCS, etc.)
  unitPrice       Decimal? @db.Decimal(10, 2) // UNIT PRICE from Excel
  currency        String? // CURRENCY from Excel (USD, SR, etc.)
  amount          Decimal? @db.Decimal(10, 2) // AMOUNT from Excel
  packing         String? // PACKING from Excel
  packageQuantity Int? // PACKAGE QUANTITY (CTN) from Excel
  unitGW          Decimal? @db.Decimal(10, 2) // UNIT G.W. (KGS) from Excel
  totalGW         Decimal? @db.Decimal(10, 2) // TOTAL G.W. (KGS) from Excel
  // Carton dimensions
  cartonLength    Decimal? @db.Decimal(10, 2) // CARTON SIZE (CM) - Length
  cartonWidth     Decimal? @db.Decimal(10, 2) // CARTON SIZE (CM) - Width
  cartonHeight    Decimal? @db.Decimal(10, 2) // CARTON SIZE (CM) - Height
  totalCBM        Decimal  @db.Decimal(10, 4) // TOTAL CBM from Excel
  // Legacy fields (for backward compatibility)
  cartons         Int      @default(0) // Number of cartons
  length          Decimal? @db.Decimal(10, 2) // cm (alias for cartonLength)
  width           Decimal? @db.Decimal(10, 2) // cm (alias for cartonWidth)
  height          Decimal? @db.Decimal(10, 2) // cm (alias for cartonHeight)
  cbm             Decimal  @db.Decimal(10, 3) // Calculated: (L*W*H)/1,000,000 (alias for totalCBM)
  weight          Decimal? @db.Decimal(10, 2) // kg (alias for totalGW)
  country         String?
  city            String?
  images          String?  @db.Text // JSON array of image URLs (IMAGE from Excel)
  notes           String?  @db.Text
  displayOrder    Int      @default(0) // NO from Excel
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  offer     Offer      @relation(fields: [offerId], references: [id], onDelete: Cascade)
  dealItems DealItem[]

  @@index([offerId])
  @@index([itemNo])
}

// ============================================
// DEAL MANAGEMENT
// ============================================

model Deal {
  id                 String     @id @default(uuid())
  dealNumber         String     @unique // Auto-generated (e.g., DEAL-2024-001)
  offerId            String
  traderId           String
  clientId           String
  employeeId         String // Guarantor employee
  shippingCompanyId  String? // Assigned shipping company
  status             DealStatus @default(NEGOTIATION)
  negotiatedAmount   Decimal?   @db.Decimal(10, 2) // Agreed amount
  totalCartons       Int        @default(0)
  totalCBM           Decimal    @default(0) @db.Decimal(10, 3)
  invoiceNumber      String?    @unique
  invoiceUrl         String? // PDF invoice URL
  barcode            String?    @unique
  qrCodeUrl          String? // QR code for deal
  notes              String?    @db.Text
  approvedAt         DateTime?
  paidAt             DateTime?
  settledAt          DateTime?
  cancelledAt        DateTime?
  cancellationReason String?    @db.Text
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // Relations
  offer            Offer               @relation(fields: [offerId], references: [id])
  trader           Trader              @relation(fields: [traderId], references: [id])
  client           Client              @relation(fields: [clientId], references: [id])
  employee         Employee            @relation(fields: [employeeId], references: [id])
  shippingCompany  ShippingCompany?    @relation(fields: [shippingCompanyId], references: [id])
  shippingTracking ShippingTracking?
  items            DealItem[]
  negotiations     DealNegotiation[]
  payments         Payment[]
  invoices         Invoice[]
  statusHistory    DealStatusHistory[]
  activityLogs     ActivityLog[]       @relation("ActivityLogDeal")
  auditTrails      AuditTrail[]        @relation("AuditTrailDeal")

  @@index([offerId])
  @@index([traderId])
  @@index([clientId])
  @@index([employeeId])
  @@index([shippingCompanyId])
  @@index([status])
  @@index([dealNumber])
}

model DealItem {
  id              String   @id @default(uuid())
  dealId          String
  offerItemId     String
  quantity        Int // Negotiated quantity
  cartons         Int
  cbm             Decimal  @db.Decimal(10, 3)
  negotiatedPrice Decimal? @db.Decimal(10, 2) // Per unit if applicable
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  deal      Deal      @relation(fields: [dealId], references: [id], onDelete: Cascade)
  offerItem OfferItem @relation(fields: [offerItemId], references: [id])

  @@index([dealId])
  @@index([offerItemId])
}

model DealStatusHistory {
  id            String     @id @default(uuid())
  dealId        String
  status        DealStatus
  description   String?    @db.Text
  changedBy     String? // User ID who changed
  changedByType UserType
  createdAt     DateTime   @default(now())

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
}

// ============================================
// NEGOTIATION SYSTEM
// ============================================

model DealNegotiation {
  id               String                 @id @default(uuid())
  dealId           String
  traderId         String
  clientId         String
  senderId         String                 @default("") // ID of the user who sent the message (clientId, traderId, or employeeId)
  senderType       String                 @default("CLIENT") // 'CLIENT', 'TRADER', or 'EMPLOYEE'
  messageType      NegotiationMessageType @default(TEXT)
  message          String                 @db.Text
  proposedPrice    Decimal?               @db.Decimal(10, 2)
  proposedQuantity Int?
  isRead           Boolean                @default(false)
  readAt           DateTime?
  createdAt        DateTime               @default(now())

  // Relations
  deal   Deal   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  trader Trader @relation("DealNegotiationTrader", fields: [traderId], references: [id])
  client Client @relation("DealNegotiationClient", fields: [clientId], references: [id])

  @@index([dealId])
  @@index([traderId])
  @@index([clientId])
  @@index([createdAt])
}

// ============================================
// FINANCIAL INTERMEDIARY SYSTEM
// ============================================

model Payment {
  id            String        @id @default(uuid())
  dealId        String
  clientId      String
  amount        Decimal       @db.Decimal(10, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  transactionId String?       @unique
  receiptUrl    String? // Payment receipt
  verifiedAt    DateTime?
  verifiedBy    String? // Employee ID
  notes         String?       @db.Text
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  deal                 Deal                  @relation(fields: [dealId], references: [id])
  client               Client                @relation(fields: [clientId], references: [id])
  financialTransaction FinancialTransaction?

  @@index([dealId])
  @@index([clientId])
  @@index([status])
  @@index([transactionId])
}

model FinancialTransaction {
  id          String            @id @default(uuid())
  dealId      String?
  paymentId   String?           @unique
  type        TransactionType
  amount      Decimal           @db.Decimal(10, 2)
  status      TransactionStatus @default(PENDING)
  description String?           @db.Text

  // Commission breakdown
  platformCommission Decimal? @db.Decimal(10, 2)
  employeeCommission Decimal? @db.Decimal(10, 2)
  traderAmount       Decimal? @db.Decimal(10, 2)

  // Related entities
  employeeId  String?
  traderId    String?
  processedBy String? // Admin/Employee ID
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  payment  Payment?  @relation(fields: [paymentId], references: [id])
  employee Employee? @relation("FinancialTransactionEmployee", fields: [employeeId], references: [id])
  admin    Admin?    @relation("FinancialTransactionAdmin", fields: [processedBy], references: [id])

  @@index([dealId])
  @@index([paymentId])
  @@index([type])
  @@index([status])
}

model FinancialLedger {
  id            String   @id @default(uuid())
  transactionId String // FinancialTransaction ID
  entryType     String // DEBIT or CREDIT
  accountType   String // PLATFORM, EMPLOYEE, TRADER, CLIENT
  accountId     String? // ID of the account holder
  amount        Decimal  @db.Decimal(10, 2)
  balanceBefore Decimal  @db.Decimal(10, 2)
  balanceAfter  Decimal  @db.Decimal(10, 2)
  description   String?  @db.Text
  reference     String? // Deal number, invoice number, etc.
  createdAt     DateTime @default(now())

  @@index([transactionId])
  @@index([accountType, accountId])
  @@index([createdAt])
}

model Invoice {
  id                 String        @id @default(uuid())
  dealId             String
  invoiceNumber      String        @unique
  invoiceUrl         String // PDF URL
  qrCodeUrl          String? // QR code for invoice
  status             InvoiceStatus @default(DRAFT)
  subtotal           Decimal       @db.Decimal(10, 2)
  platformCommission Decimal       @db.Decimal(10, 2)
  shippingCommission Decimal       @db.Decimal(10, 2) @default(0) // Shipping commission (paid by buyer)
  employeeCommission Decimal       @db.Decimal(10, 2)
  traderAmount       Decimal       @db.Decimal(10, 2)
  total              Decimal       @db.Decimal(10, 2)
  tax                Decimal?      @db.Decimal(10, 2)
  issuedAt           DateTime?
  paidAt             DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Relations
  deal Deal @relation(fields: [dealId], references: [id])

  @@index([dealId])
  @@index([invoiceNumber])
  @@index([status])
}

// ============================================
// AUDIT & ACTIVITY LOGGING
// ============================================

model ActivityLog {
  id       String   @id @default(uuid())
  userType UserType

  // Split user ID fields
  adminId     String?
  moderatorId String?
  employeeId  String?
  traderId    String?
  clientId    String?

  action     String
  entityType String? // DEAL, OFFER, NEGOTIATION, PAYMENT, etc.

  // Split entity ID fields
  dealId  String?
  offerId String?

  description String?  @db.Text
  changes     String?  @db.Text // JSON
  ipAddress   String?
  userAgent   String?
  location    String?
  metadata    String?  @db.Text // JSON
  createdAt   DateTime @default(now())

  // Relations - Specific foreign keys
  admin     Admin?     @relation("ActivityLogAdmin", fields: [adminId], references: [id])
  moderator Moderator? @relation("ActivityLogModerator", fields: [moderatorId], references: [id])
  employee  Employee?  @relation("ActivityLogEmployee", fields: [employeeId], references: [id])
  trader    Trader?    @relation("ActivityLogTrader", fields: [traderId], references: [id])
  client    Client?    @relation("ActivityLogClient", fields: [clientId], references: [id])
  deal      Deal?      @relation("ActivityLogDeal", fields: [dealId], references: [id])
  offer     Offer?     @relation("ActivityLogOffer", fields: [offerId], references: [id])

  @@index([adminId])
  @@index([moderatorId])
  @@index([employeeId])
  @@index([traderId])
  @@index([clientId])
  @@index([dealId])
  @@index([offerId])
  @@index([userType])
  @@index([entityType])
  @@index([createdAt])
}

model AuditTrail {
  id       String   @id @default(uuid())
  userType UserType

  // Split user ID fields
  adminId     String?
  moderatorId String?
  employeeId  String?
  traderId    String?
  clientId    String?

  action     AuditAction
  entityType String?

  // Split entity ID fields
  dealId String?

  oldValue     String?  @db.Text // JSON
  newValue     String?  @db.Text // JSON
  reason       String?  @db.Text
  ipAddress    String?
  userAgent    String?
  success      Boolean  @default(true)
  errorMessage String?  @db.Text
  createdAt    DateTime @default(now())

  // Relations - Specific foreign keys
  admin     Admin?     @relation("AuditTrailAdmin", fields: [adminId], references: [id])
  moderator Moderator? @relation("AuditTrailModerator", fields: [moderatorId], references: [id])
  employee  Employee?  @relation("AuditTrailEmployee", fields: [employeeId], references: [id])
  trader    Trader?    @relation("AuditTrailTrader", fields: [traderId], references: [id])
  client    Client?    @relation("AuditTrailClient", fields: [clientId], references: [id])
  deal      Deal?      @relation("AuditTrailDeal", fields: [dealId], references: [id])

  @@index([adminId])
  @@index([moderatorId])
  @@index([employeeId])
  @@index([traderId])
  @@index([clientId])
  @@index([dealId])
  @@index([userType])
  @@index([action])
  @@index([createdAt])
}

// ============================================
// CATEGORY MANAGEMENT
// ============================================

model Category {
  id                        String   @id @default(uuid())
  nameKey                   String   @unique // Translation key
  descriptionKey            String?  @db.Text
  slug                      String   @unique
  parentId                  String?
  isActive                  Boolean  @default(true)
  isFeatured                Boolean  @default(false)
  displayOrder              Int      @default(0)
  icon                      String?
  imageUrl                  String?
  level                     Int      @default(0)
  productCount              Int      @default(0)
  breadcrumb                String?
  metaTitleKey              String?
  metaDescriptionKey        String?  @db.Text
  metaKeywords              String?  @db.Text
  canonicalUrl              String?
  ogTitleKey                String?
  ogDescriptionKey          String?  @db.Text
  ogImage                   String?
  twitterCardTitleKey       String?
  twitterCardDescriptionKey String?  @db.Text
  twitterCardImage          String?
  structuredData            String?  @db.Text
  pageDescriptionKey        String?  @db.Text
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children Category[] @relation("CategoryTree")
  offers   Offer[]    @relation("OfferCategory") // Offers in this category

  @@index([parentId])
  @@index([slug])
  @@index([isActive])
  @@index([isFeatured])
  @@index([displayOrder])
}

// ============================================
// SLIDER MANAGEMENT
// ============================================

model Slider {
  id            String   @id @default(uuid())
  titleAr       String   @db.Text
  titleEn       String   @db.Text
  descriptionAr String?  @db.Text
  descriptionEn String?  @db.Text
  imageUrl      String
  imageAlt      String?
  linkUrl       String?
  linkTextAr    String?
  linkTextEn    String?
  displayOrder  Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive])
  @@index([displayOrder])
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

model Notification {
  id                String    @id @default(uuid())
  userId            String
  userType          UserType
  type              String // DEAL, NEGOTIATION, PAYMENT, etc.
  title             String
  message           String    @db.Text
  relatedEntityType String?
  relatedEntityId   String?
  isRead            Boolean   @default(false)
  readAt            DateTime?
  createdAt         DateTime  @default(now())

  @@index([userId, userType])
  @@index([isRead])
  @@index([createdAt])
}

// ============================================
// BACKUP & EXPORT
// ============================================

model Backup {
  id           String    @id @default(uuid())
  backupType   String // DATABASE, EXCEL_FILES, INVOICES
  fileUrl      String
  fileSize     Int? // bytes
  recordCount  Int?
  status       String // PENDING, COMPLETED, FAILED
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  errorMessage String?   @db.Text
  createdAt    DateTime  @default(now())

  @@index([backupType])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// CONTENT MANAGEMENT
// ============================================

enum ContentPageType {
  SUPPORT_CENTER
  CONTACT_US
  TERMS_AND_CONDITIONS
  PRIVACY_POLICY
  ABOUT_COMPANY
  SUPPORT_TEXT
  FAQ
  HELP
  OTHER
}

model ContentPage {
  id              String          @id @default(uuid())
  type            ContentPageType
  title           String
  slug            String          @unique
  content         String          @db.Text
  excerpt         String?         @db.Text
  metaTitle       String?
  metaDescription String?         @db.Text
  metaKeywords    String?         @db.Text
  isActive        Boolean         @default(true)
  isPublished     Boolean         @default(false)
  publishedAt     DateTime?
  language        String          @default("ar")
  order           Int             @default(0)
  views           Int             @default(0)
  email           String?
  phone           String?
  address         String?         @db.Text
  workingHours    String?         @db.Text
  socialMedia     String?         @db.Text
  category        String?
  priority        String?
  createdBy       String?
  updatedBy       String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  creator Admin? @relation("ContentPageCreator", fields: [createdBy], references: [id])
  updater Admin? @relation("ContentPageUpdater", fields: [updatedBy], references: [id])

  @@index([type])
  @@index([slug])
  @@index([isActive])
  @@index([isPublished])
  @@index([language])
  @@index([createdAt])
}

// ============================================
// SHIPPING COMPANIES MANAGEMENT
// ============================================

model ShippingCompany {
  id          String   @id @default(uuid())
  nameAr      String   @default("") // Arabic name
  nameEn      String   @default("") // English name
  avatar      String? // Avatar/logo image URL
  address     String?  @db.Text
  contactName String?
  phone       String?
  email       String?
  notes       String?  @db.Text
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  deals          Deal[]
  shippingTracks ShippingTracking[]

  @@index([status])
  @@index([nameAr])
  @@index([nameEn])
}

enum ShippingStatus {
  PENDING // في انتظار الشحن
  PREPARING // جاري التحضير
  PICKED_UP // تم الاستلام من التاجر
  IN_TRANSIT // في الطريق
  OUT_FOR_DELIVERY // جاري التوصيل
  DELIVERED // تم التسليم
  RETURNED // تم الإرجاع
  CANCELLED // ملغاة
}

model ShippingTracking {
  id                String         @id @default(uuid())
  dealId            String         @unique
  shippingCompanyId String?
  trackingNumber    String?        @unique // رقم التتبع من شركة الشحن
  status            ShippingStatus @default(PENDING)
  currentLocation   String?        @db.Text // الموقع الحالي
  estimatedDelivery DateTime? // تاريخ التوصيل المتوقع
  actualDelivery    DateTime? // تاريخ التسليم الفعلي
  notes             String?        @db.Text
  updatedBy         String? // User ID who updated
  updatedByType     UserType? // User type who updated
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  deal            Deal                    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  shippingCompany ShippingCompany?        @relation(fields: [shippingCompanyId], references: [id])
  statusHistory   ShippingStatusHistory[]

  @@index([shippingCompanyId])
  @@index([trackingNumber])
  @@index([status])
  @@index([createdAt])
}

model ShippingStatusHistory {
  id                 String         @id @default(uuid())
  shippingTrackingId String
  status             ShippingStatus
  location           String?        @db.Text
  description        String?        @db.Text
  updatedBy          String? // User ID
  updatedByType      UserType? // User type
  createdAt          DateTime       @default(now())

  // Relations
  shippingTracking ShippingTracking @relation(fields: [shippingTrackingId], references: [id], onDelete: Cascade)

  @@index([shippingTrackingId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// TRADER UPDATE REQUESTS
// ============================================

model TraderUpdateRequest {
  id       String                    @id @default(uuid())
  traderId String
  status   TraderUpdateRequestStatus @default(PENDING)

  // Requested changes (JSON to store all fields)
  requestedData Json @db.Json

  // Review information
  reviewedBy     String? // Employee or Admin ID
  reviewedByType UserType? // EMPLOYEE or ADMIN
  reviewedAt     DateTime?
  reviewNotes    String?   @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trader   Trader    @relation(fields: [traderId], references: [id], onDelete: Cascade)
  reviewer Employee? @relation("TraderUpdateRequestReviewer", fields: [reviewedBy], references: [id])

  @@index([traderId])
  @@index([status])
  @@index([reviewedBy])
  @@index([createdAt])
}

// ============================================
// OFFER UPDATE REQUESTS
// ============================================

model OfferUpdateRequest {
  id       String                  @id @default(uuid())
  offerId String
  status  OfferUpdateRequestStatus @default(PENDING)

  // Requested changes (JSON to store all fields)
  requestedData Json @db.Json

  // Review information
  reviewedBy     String? // Employee or Admin ID
  reviewedByType UserType? // EMPLOYEE or ADMIN
  reviewedAt     DateTime?
  reviewNotes    String?   @db.Text

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  offer    Offer     @relation(fields: [offerId], references: [id], onDelete: Cascade)
  reviewer Employee? @relation("OfferUpdateRequestReviewer", fields: [reviewedBy], references: [id])

  @@index([offerId])
  @@index([status])
  @@index([reviewedBy])
  @@index([createdAt])
}

// ============================================
// OFFER SUPPORT TICKETS
// ============================================

model OfferSupportTicket {
  id          String                      @id @default(uuid())
  offerId     String
  traderId    String // Trader who created the ticket
  employeeId  String? // Employee assigned to handle the ticket
  subject     String
  status      OfferSupportTicketStatus    @default(OPEN)
  priority    OfferSupportTicketPriority  @default(MEDIUM)
  
  // Timestamps
  createdAt   DateTime                    @default(now())
  updatedAt   DateTime                    @updatedAt
  resolvedAt  DateTime?
  closedAt    DateTime?

  // Relations
  offer       Offer                       @relation(fields: [offerId], references: [id], onDelete: Cascade)
  trader      Trader                      @relation("OfferSupportTicketTrader", fields: [traderId], references: [id], onDelete: Cascade)
  employee    Employee?                   @relation("OfferSupportTicketEmployee", fields: [employeeId], references: [id], onDelete: SetNull)
  messages    OfferSupportTicketMessage[]

  @@index([offerId])
  @@index([traderId])
  @@index([employeeId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}

model OfferSupportTicketMessage {
  id          String                @id @default(uuid())
  ticketId    String
  senderId    String // ID of sender (trader or employee)
  senderType  UserType // TRADER or EMPLOYEE
  message     String                @db.Text
  attachments String?               @db.Text // JSON array of file URLs
  
  // Timestamps
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  readAt      DateTime? // When the message was read by the recipient

  // Relations
  ticket      OfferSupportTicket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([senderId])
  @@index([senderType])
  @@index([createdAt])
}

// ============================================
// PLATFORM SETTINGS
// ============================================

model PlatformSettings {
  id                     String   @id @default(uuid())
  platformCommissionRate Decimal? @db.Decimal(5, 2)
  shippingCommissionRate Decimal? @db.Decimal(5, 2) @default(5.00) // Shipping commission rate (default 5%)
  cbmRate                Decimal? @db.Decimal(10, 2)
  taxRate                Decimal? @db.Decimal(5, 2)
  currency               String?  @default("SAR")
  platformName           String?  @default("Stockship")
  platformEmail          String?
  platformPhone          String?
  platformAddress        String?  @db.Text
  defaultLanguage        String?  @default("ar")
  timezone               String?  @default("Asia/Riyadh")
  commissionMethod       String?  @default("PERCENTAGE")
  updatedBy              String?
  updatedAt              DateTime @updatedAt
  createdAt              DateTime @default(now())

  updater Admin? @relation("PlatformSettingsUpdater", fields: [updatedBy], references: [id])

  @@index([updatedBy])
}
