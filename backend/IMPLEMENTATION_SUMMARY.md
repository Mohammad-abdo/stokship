# ููุฎุต ุงูุชูููุฐ: ูุธุงู ุฅูุบุงุก ุงูุทูุจุงุช ุบูุฑ ุงููุฏููุนุฉ

## โ ูุง ุชู ุฅูุฌุงุฒู

ุชู ุฅูุดุงุก ูุธุงู ูุงูู ููุชูุงูู ูุฅูุบุงุก ุงูุทูุจุงุช ุบูุฑ ุงููุฏููุนุฉ ุชููุงุฆูุงู ุจุนุฏ 72 ุณุงุนุฉ ูู ุฅูุดุงุฆูุง.

## ๐ฆ ุงููููุงุช ุงููุถุงูุฉ/ุงููุนุฏูุฉ

### ูููุงุช ุฌุฏูุฏุฉ

1. **src/jobs/cancelUnpaidOrders.js**
   - ุงููููุฉ ุงูุฑุฆูุณูุฉ ูุฅูุบุงุก ุงูุทูุจุงุช
   - ุชุนูู ุญุณุจ ุฌุฏูู cron ูุงุจู ููุชุฎุตูุต
   - ุชุฏุนู ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ

2. **src/jobs/index.js**
   - ููู ุชููุฆุฉ ุฌููุน ุงูููุงู ุงููุฌุฏููุฉ
   - ูุชู ุงุณุชุฏุนุงุคู ุนูุฏ ุจุฏุก ุงูุฎุงุฏู

3. **src/jobs/config.js**
   - ุฅุนุฏุงุฏุงุช ุงูููุงู ุงููุงุจูุฉ ููุชุฎุตูุต
   - ููุฑุฃ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ

4. **src/jobs/testCancelUnpaid.js**
   - ุฃุฏุงุฉ ุงุฎุชุจุงุฑ ูุฏููุฉ
   - ุชุณูุญ ุจูุญุต ุงูุทูุจุงุช ูุจู ุงูุฅูุบุงุก
   - ุชุชุทูุจ ุชุฃููุฏ ููุชูููุฐ

5. **src/jobs/README.md**
   - ุชูุซูู ุดุงูู ููููุงู ุงููุฌุฏููุฉ
   - ุดุฑุญ ููููุฉ ุฅุถุงูุฉ ููุงู ุฌุฏูุฏุฉ

6. **src/jobs/ENV_VARIABLES.md**
   - ุดุฑุญ ููุตู ูุฌููุน ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ
   - ุฃูุซูุฉ ููุงุณุชุฎุฏุงู

7. **CANCEL_UNPAID_ORDERS.md**
   - ุฏููู ุงููุณุชุฎุฏู ุงูุดุงูู
   - ุฃูุซูุฉ ูุญุงูุงุช ุงุณุชุฎุฏุงู
   - ุงูุฃุณุฆูุฉ ุงูุดุงุฆุนุฉ

8. **IMPLEMENTATION_SUMMARY.md** (ูุฐุง ุงูููู)
   - ููุฎุต ุงูุชูููุฐ

### ูููุงุช ูุนุฏูุฉ

1. **src/server.js**
   - ุฅุถุงูุฉ ุงุณุชูุฑุงุฏ `initScheduledJobs`
   - ุชุดุบูู ุงูููุงู ุงููุฌุฏููุฉ ุนูุฏ ุจุฏุก ุงูุฎุงุฏู

2. **package.json**
   - ุฅุถุงูุฉ `node-cron` ููููุงู ุงููุฌุฏููุฉ
   - ุฅุถุงูุฉ scripts ููุงุฎุชุจุงุฑ:
     - `npm run job:cancel-unpaid` (ุนุฑุถ ููุท)
     - `npm run job:cancel-unpaid:confirm` (ุชูููุฐ)

## ๐ฏ ุงูููุฒุงุช ุงููููุฐุฉ

### 1. ุงููุญุต ุงูุชููุงุฆู
- โ ูุนูู ูู ุณุงุนุฉ (ูุงุจู ููุชุนุฏูู)
- โ ูุจุญุซ ุนู ุงูุทูุจุงุช ุงูุฃูุฏู ูู 72 ุณุงุนุฉ
- โ ูุชุญูู ูู ุญุงูุฉ ุงูุฏูุน

### 2. ุงูุฅูุบุงุก ุงูุขูู
- โ ูุง ููุบู ุงูุทูุจุงุช ุงููุฏููุนุฉ
- โ ูุง ููุบู ุงูุทูุจุงุช ุงูููุชููุฉ
- โ ูุง ููุบู ุงูุทูุจุงุช ุงูููุบุงุฉ ูุณุจูุงู

### 3. ุงูุชุชุจุน ูุงูุณุฌูุงุช
- โ ูุญุฏุซ ุญูู `cancelledAt` ูู ุงูุทูุจ
- โ ูุถูู `cancellationReason` ูุฎุตุต
- โ ููุดุฆ ุณุฌู ูู `OrderTracking`
- โ ููุชุจ ุณุฌูุงุช ููุตูุฉ ูู logs

### 4. ุงูุฅุดุนุงุฑุงุช
- โ ูุฑุณู ุฅุดุนุงุฑ ูููุณุชุฎุฏู
- โ ูุงุจู ููุชูุนูู/ุงูุชุนุทูู

### 5. ุงูุชุฎุตูุต
- โ ุงููุฏุฉ ุงูุฒูููุฉ ูุงุจูุฉ ููุชุบููุฑ
- โ ุฌุฏูู ุงูุชุดุบูู ูุงุจู ููุชุนุฏูู
- โ ุฑุณุงูุฉ ุงูุฅูุบุงุก ูุงุจูุฉ ููุชุฎุตูุต
- โ ูููู ุชุนุทูู ุงููุธุงู ูุงููุงู

## ๐ ููููุฉ ุงูุงุณุชุฎุฏุงู

### ุงูุจุฏุก ุงูุณุฑูุน

```bash
# ุชุดุบูู ุงูุฎุงุฏู (ุณูุนูู ุงููุธุงู ุชููุงุฆูุงู)
npm start
```

### ุงูุงุฎุชุจุงุฑ

```bash
# ุนุฑุถ ุงูุทูุจุงุช ุงูุชู ุณูุชู ุฅูุบุงุคูุง
npm run job:cancel-unpaid

# ุชูููุฐ ุงูุฅูุบุงุก ูุนููุงู
npm run job:cancel-unpaid:confirm
```

### ุงูุชุฎุตูุต

ุฃุถู ุฅูู ููู `.env`:

```env
# ุงููุฏุฉ ุจุงูุณุงุนุงุช (ุงูุงูุชุฑุงุถู: 72)
UNPAID_ORDER_CANCEL_HOURS=72

# ุฌุฏูู Cron (ุงูุงูุชุฑุงุถู: ูู ุณุงุนุฉ)
UNPAID_ORDER_CRON_SCHEDULE=0 * * * *

# ุชูุนูู/ุชุนุทูู
UNPAID_ORDER_CANCEL_ENABLED=true

# ุฅุฑุณุงู ุฅุดุนุงุฑุงุช
UNPAID_ORDER_SEND_NOTIFICATIONS=true

# ุฑุณุงูุฉ ูุฎุตุตุฉ
UNPAID_ORDER_CANCEL_MESSAGE=ุชู ุฅูุบุงุก ุงูุทูุจ ุชููุงุฆูุงู ุจุณุจุจ ุนุฏู ุงูุฏูุน ุฎูุงู {hours} ุณุงุนุฉ
```

## ๐ ููุทู ุงูุนูู

```
ูู ุณุงุนุฉ (ุฃู ุญุณุจ ุงูุฌุฏูู)
    โ
ุงูุจุญุซ ุนู ุงูุทูุจุงุช:
  - createdAt < (ุงูุขู - 72 ุณุงุนุฉ)
  - status NOT IN (CANCELLED, COMPLETED, PAYMENT_CONFIRMED)
  - ูุง ููุฌุฏ ุฏูุนุฉ ุจุญุงูุฉ COMPLETED
    โ
ููู ุทูุจ:
  1. ุชุญุฏูุซ status โ CANCELLED
  2. ุชุญุฏูุซ cancelledAt โ ุงูุขู
  3. ุชุญุฏูุซ cancellationReason โ ุงูุฑุณุงูุฉ ุงููุฎุตุตุฉ
  4. ุฅูุดุงุก OrderTracking
  5. ุฅุฑุณุงู ุฅุดุนุงุฑ (ุฅุฐุง ููุนูู)
    โ
ุชุณุฌูู ุงููุชุงุฆุฌ ูู logs
```

## ๐ ุงูุชุญูู ูู ุงูุญููู ุงููุทููุจุฉ

ูุชุทูุจ ุงููุธุงู ูุฌูุฏ ุงูุญููู ุงูุชุงููุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

### ุฌุฏูู Orders
- โ `id`
- โ `orderNumber`
- โ `userId`
- โ `status`
- โ `createdAt`
- โ `cancelledAt`
- โ `cancellationReason`

### ุฌุฏูู OrderTracking
- โ `orderId`
- โ `status`
- โ `description`
- โ `updatedByType`

### ุฌุฏูู Payment
- โ `orderId`
- โ `status`

### ุฌุฏูู Notification
- โ `userId`
- โ `userType`
- โ `type`
- โ `title`
- โ `message`
- โ `relatedEntityType`
- โ `relatedEntityId`

## โ๏ธ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ

| ุงููุชุบูุฑ | ุงููุตู | ุงูุงูุชุฑุงุถู |
|---------|-------|-----------|
| `UNPAID_ORDER_CANCEL_HOURS` | ุนุฏุฏ ุงูุณุงุนุงุช ูุจู ุงูุฅูุบุงุก | 72 |
| `UNPAID_ORDER_CRON_SCHEDULE` | ุฌุฏูู cron ููุชุดุบูู | `0 * * * *` |
| `UNPAID_ORDER_CANCEL_ENABLED` | ุชูุนูู/ุชุนุทูู ุงููุธุงู | true |
| `UNPAID_ORDER_SEND_NOTIFICATIONS` | ุฅุฑุณุงู ุฅุดุนุงุฑุงุช | true |
| `UNPAID_ORDER_CANCEL_MESSAGE` | ุฑุณุงูุฉ ุงูุฅูุบุงุก | ูุต ุงูุชุฑุงุถู |

## ๐ ุฃูุซูุฉ ุฌุฏุงูู Cron

```bash
# ูู ุณุงุนุฉ
0 * * * *

# ูู 6 ุณุงุนุงุช
0 */6 * * *

# ูู ููู ูู ุงูุณุงุนุฉ 2 ุตุจุงุญุงู
0 2 * * *

# ูู 30 ุฏูููุฉ
*/30 * * * *

# ูู ููู ุฃุญุฏ ูู ููุชุตู ุงูููู
0 0 * * 0
```

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ูุฏูู

```bash
# 1. ุนุฑุถ ุงูุทูุจุงุช ููุท
npm run job:cancel-unpaid

# 2. ุชูููุฐ ุงูุฅูุบุงุก
npm run job:cancel-unpaid:confirm
```

### ุงุฎุชุจุงุฑ ูู ุจูุฆุฉ ุงูุชุทููุฑ

```bash
# 1. ุถุจุท ุงููุฏุฉ ูู 1 ุณุงุนุฉ ููุงุฎุชุจุงุฑ
UNPAID_ORDER_CANCEL_HOURS=1

# 2. ุถุจุท ุงูุฌุฏูู ููู ุฏูููุฉ
UNPAID_ORDER_CRON_SCHEDULE=* * * * *

# 3. ุชุดุบูู ุงูุฎุงุฏู ููุฑุงูุจุฉ logs
npm run dev
```

## ๐ ูุงุฆูุฉ ุงูุชุญูู

- [x] ุชุซุจูุช `node-cron`
- [x] ุฅูุดุงุก ูุฌูุฏ `src/jobs`
- [x] ุฅูุดุงุก ููู ุงููููุฉ ุงูุฑุฆูุณูุฉ
- [x] ุฅูุดุงุก ููู ุงูุฅุนุฏุงุฏุงุช
- [x] ุฅูุดุงุก ููู ุงูุงุฎุชุจุงุฑ
- [x] ุชุญุฏูุซ `server.js`
- [x] ุชุญุฏูุซ `package.json`
- [x] ุฅูุดุงุก ุงูุชูุซูู ุงูุดุงูู
- [x] ุงุฎุชุจุงุฑ ุนุฏู ูุฌูุฏ ุฃุฎุทุงุก linting

## ๐ ุงูุฎูุงุตุฉ

ุชู ุฅูุดุงุก ูุธุงู ูุชูุงูู ููุงุจู ููุชุฎุตูุต ุจุงููุงูู ูุฅูุบุงุก ุงูุทูุจุงุช ุบูุฑ ุงููุฏููุนุฉ ุชููุงุฆูุงู. ุงููุธุงู:
- โ ูุนูู ุชููุงุฆูุงู ุนูุฏ ุชุดุบูู ุงูุฎุงุฏู
- โ ุขูู ููุง ููุบู ุทูุจุงุช ุฎุงุทุฆุฉ
- โ ูุงุจู ููุชุฎุตูุต ุจุงููุงูู
- โ ูุญุชูู ุนูู ุฃุฏูุงุช ุงุฎุชุจุงุฑ
- โ ููุซู ุจุดูู ุดุงูู
- โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู ูู ุงูุฅูุชุงุฌ

## ๐ ุงููุฑุงุฌุน

- [CANCEL_UNPAID_ORDERS.md](./CANCEL_UNPAID_ORDERS.md) - ุฏููู ุงููุณุชุฎุฏู ุงูุดุงูู
- [src/jobs/README.md](./src/jobs/README.md) - ุชูุซูู ุงูููุงู ุงููุฌุฏููุฉ
- [src/jobs/ENV_VARIABLES.md](./src/jobs/ENV_VARIABLES.md) - ุดุฑุญ ุงููุชุบูุฑุงุช ุงูุจูุฆูุฉ
