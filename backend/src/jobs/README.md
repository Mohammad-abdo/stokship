# المهام المجدولة (Cron Jobs)

هذا المجلد يحتوي على جميع المهام المجدولة التي تعمل تلقائياً في الخلفية.

## المهام الحالية

### 1. إلغاء الطلبات غير المدفوعة (cancelUnpaidOrders.js)

**الوصف:** يقوم تلقائياً بإلغاء الطلبات التي لم يتم دفعها خلال 72 ساعة من إنشائها.

**جدول التشغيل:** كل ساعة (يمكن تعديله)

**المنطق:**
- يبحث عن الطلبات التي تم إنشاؤها قبل أكثر من 72 ساعة
- يتحقق من أن حالة الطلب ليست CANCELLED أو COMPLETED أو PAYMENT_CONFIRMED
- يتحقق من عدم وجود دفعة بحالة COMPLETED للطلب
- يقوم بتحديث حالة الطلب إلى CANCELLED
- ينشئ سجل تتبع للإلغاء
- يرسل إشعار للمستخدم

**تعديل جدول التشغيل:**

في ملف `cancelUnpaidOrders.js`، يمكنك تعديل الجدول الزمني:

```javascript
// كل ساعة
cron.schedule('0 * * * *', async () => {

// كل 6 ساعات
cron.schedule('0 */6 * * *', async () => {

// كل يوم في منتصف الليل
cron.schedule('0 0 * * *', async () => {

// كل 30 دقيقة
cron.schedule('*/30 * * * *', async () => {
```

**صيغة Cron:**
```
* * * * *
│ │ │ │ │
│ │ │ │ └── اليوم من الأسبوع (0-7) (الأحد = 0 أو 7)
│ │ │ └──── الشهر (1-12)
│ │ └────── اليوم من الشهر (1-31)
│ └──────── الساعة (0-23)
└────────── الدقيقة (0-59)
```

## إضافة مهمة جديدة

1. أنشئ ملف جديد في مجلد `jobs` (مثال: `myNewJob.js`)
2. استخدم هذا القالب:

```javascript
const cron = require('node-cron');
const prisma = require('../config/database');
const { logger } = require('../utils/logger');

const myNewJob = () => {
  cron.schedule('0 * * * *', async () => {
    try {
      logger.info('بدء تنفيذ المهمة...');
      
      // أضف منطق المهمة هنا
      
      logger.info('اكتملت المهمة بنجاح');
    } catch (error) {
      logger.error('خطأ في تنفيذ المهمة:', error);
    }
  });
  
  logger.info('تم تفعيل المهمة');
};

module.exports = { myNewJob };
```

3. أضف المهمة في `jobs/index.js`:

```javascript
const { myNewJob } = require('./myNewJob');

const initScheduledJobs = () => {
  // ... المهام الموجودة
  myNewJob();
};
```

## السجلات (Logs)

جميع المهام تكتب سجلاتها في:
- الإنتاج: ملفات السجلات في `/logs`
- التطوير: Console

## تعطيل المهام

لتعطيل مهمة معينة، قم بتعليق السطر الخاص بها في `jobs/index.js`:

```javascript
const initScheduledJobs = () => {
  // cancelUnpaidOrdersJob(); // معطل مؤقتاً
};
```

## الاختبار

لاختبار مهمة بدون انتظار الجدول الزمني:

1. قم باستيراد الدالة مباشرة
2. نفذ المنطق داخل الـ cron.schedule بشكل منفصل
3. أو قم بتشغيل الخادم ومراقبة السجلات

## الملاحظات المهمة

- تأكد من أن الخادم يعمل دائماً لتنفيذ المهام المجدولة
- في حالة استخدام Docker أو خوادم متعددة، تأكد من تشغيل المهام على خادم واحد فقط
- راجع السجلات بانتظام للتأكد من تنفيذ المهام بشكل صحيح
