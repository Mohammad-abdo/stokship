# نظام إلغاء الطلبات غير المدفوعة تلقائياً

## نظرة عامة

تم إضافة نظام مجدول (Cron Job) يقوم بفحص الطلبات غير المدفوعة وإلغائها تلقائياً بعد مرور 72 ساعة (قابل للتخصيص).

## الميزات

✅ **فحص دوري تلقائي** - يعمل كل ساعة (قابل للتعديل)
✅ **قابل للتخصيص بالكامل** - يمكن تعديل المدة الزمنية والجدول
✅ **إشعارات تلقائية** - يرسل إشعار للمستخدم عند إلغاء الطلب
✅ **سجلات تتبع** - ينشئ سجل تتبع لكل عملية إلغاء
✅ **آمن** - يتحقق من حالة الدفع قبل الإلغاء

## كيف يعمل؟

1. **الفحص الدوري**: يعمل النظام كل ساعة (افتراضياً)
2. **البحث عن الطلبات**: يبحث عن الطلبات التي:
   - تم إنشاؤها قبل أكثر من 72 ساعة
   - حالتها ليست: CANCELLED، COMPLETED، أو PAYMENT_CONFIRMED
   - لا يوجد لها دفعة بحالة COMPLETED
3. **الإلغاء**: يقوم بـ:
   - تحديث حالة الطلب إلى CANCELLED
   - تسجيل تاريخ ووقت الإلغاء
   - إنشاء سجل تتبع
   - إرسال إشعار للمستخدم

## البدء السريع

### 1. التثبيت

النظام مثبت بالفعل! عند تشغيل الخادم، سيعمل تلقائياً.

```bash
npm start
```

في السجلات، ستشاهد:
```
تم تفعيل job إلغاء الطلبات غير المدفوعة - الجدول: 0 * * * * - المدة: 72 ساعة
```

### 2. التخصيص (اختياري)

أضف هذه المتغيرات إلى ملف `.env`:

```env
# المدة قبل الإلغاء (بالساعات)
UNPAID_ORDER_CANCEL_HOURS=72

# جدول التشغيل (كل ساعة)
UNPAID_ORDER_CRON_SCHEDULE=0 * * * *

# تفعيل/تعطيل
UNPAID_ORDER_CANCEL_ENABLED=true

# إرسال إشعارات
UNPAID_ORDER_SEND_NOTIFICATIONS=true

# رسالة الإلغاء المخصصة
UNPAID_ORDER_CANCEL_MESSAGE=تم إلغاء الطلب تلقائياً بسبب عدم الدفع خلال {hours} ساعة
```

### 3. الاختبار

اختبر النظام يدوياً بدون انتظار الجدول:

```bash
# عرض الطلبات التي سيتم إلغاؤها (بدون تنفيذ)
node src/jobs/testCancelUnpaid.js

# تنفيذ الإلغاء فعلياً
node src/jobs/testCancelUnpaid.js --confirm
```

## أمثلة التخصيص

### تغيير المدة الزمنية

```env
# إلغاء بعد 24 ساعة
UNPAID_ORDER_CANCEL_HOURS=24

# إلغاء بعد 48 ساعة
UNPAID_ORDER_CANCEL_HOURS=48

# إلغاء بعد أسبوع
UNPAID_ORDER_CANCEL_HOURS=168
```

### تغيير جدول التشغيل

```env
# كل 6 ساعات
UNPAID_ORDER_CRON_SCHEDULE=0 */6 * * *

# كل يوم في الساعة 2 صباحاً
UNPAID_ORDER_CRON_SCHEDULE=0 2 * * *

# كل 30 دقيقة
UNPAID_ORDER_CRON_SCHEDULE=*/30 * * * *
```

### تعطيل مؤقت

```env
# إيقاف النظام مؤقتاً
UNPAID_ORDER_CANCEL_ENABLED=false

# إيقاف الإشعارات فقط
UNPAID_ORDER_SEND_NOTIFICATIONS=false
```

## البنية الملفات

```
backend/src/jobs/
├── index.js                    # تهيئة جميع المهام
├── config.js                   # إعدادات المهام
├── cancelUnpaidOrders.js       # المهمة الرئيسية
├── testCancelUnpaid.js         # أداة الاختبار
├── README.md                   # توثيق المهام
└── ENV_VARIABLES.md            # شرح المتغيرات البيئية
```

## المراقبة

### السجلات

راقب السجلات لمتابعة عمل النظام:

```bash
# في التطوير
npm run dev

# في الإنتاج
tail -f logs/app.log
```

ستشاهد رسائل مثل:
```
بدء فحص الطلبات غير المدفوعة (المدة: 72 ساعة)...
تم العثور على 3 طلبات غير مدفوعة
تم إلغاء الطلب SHR123456789 (ID: 45)
اكتمل فحص الطلبات. تم إلغاء 3 طلبات
```

### قاعدة البيانات

تحقق من الطلبات الملغاة:

```sql
SELECT * FROM orders 
WHERE status = 'CANCELLED' 
AND cancellationReason LIKE '%تلقائياً%'
ORDER BY cancelledAt DESC;
```

## الأسئلة الشائعة

### هل يمكنني تغيير المدة لطلبات محددة؟

حالياً، المدة موحدة لجميع الطلبات. للتخصيص حسب نوع الطلب، يمكن تعديل الكود في `cancelUnpaidOrders.js`.

### ماذا يحدث للطلبات التي تم دفعها جزئياً؟

النظام يتحقق من وجود دفعة بحالة `COMPLETED`. إذا لم توجد دفعة مكتملة، سيتم إلغاء الطلب.

### هل يمكنني استرجاع الطلبات الملغاة؟

يمكن استرجاع الطلبات يدوياً عن طريق تحديث حالتها في قاعدة البيانات، لكن يُنصح بإنشاء طلب جديد.

### كيف أعطل النظام نهائياً؟

اضبط `UNPAID_ORDER_CANCEL_ENABLED=false` في ملف `.env` أو علّق السطر التالي في `src/jobs/index.js`:

```javascript
// cancelUnpaidOrdersJob(); // معطل
```

### هل يعمل في بيئات الـ Docker؟

نعم، يعمل بشكل طبيعي. تأكد فقط من أن:
- المتغيرات البيئية محددة بشكل صحيح
- الخادم يعمل بشكل مستمر
- المنطقة الزمنية مضبوطة بشكل صحيح

## الدعم الفني

للمزيد من المعلومات، راجع:
- `src/jobs/README.md` - توثيق المهام المجدولة
- `src/jobs/ENV_VARIABLES.md` - شرح مفصل للمتغيرات البيئية
- `src/jobs/testCancelUnpaid.js` - أداة الاختبار

## الملاحظات المهمة

⚠️ **يجب إعادة تشغيل الخادم** بعد تعديل أي متغير بيئي

⚠️ **راجع السجلات بانتظام** للتأكد من عمل النظام بشكل صحيح

⚠️ **اختبر في بيئة التطوير** قبل التفعيل في الإنتاج

✅ **النظام آمن** - لن يلغي طلبات مدفوعة أو مكتملة

✅ **قابل للتوسع** - يمكن إضافة مهام مجدولة أخرى بسهولة
